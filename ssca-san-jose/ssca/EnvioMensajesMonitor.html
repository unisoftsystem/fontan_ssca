<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>ENVIO DE MENSAJES AL MONITOR</title>
<link rel="stylesheet" href="css/styles.css"/>
<link rel="stylesheet" href="css/styles.css"/>
<link href="css/style.css" rel="stylesheet"/>
<link href="css/menu.css" rel="stylesheet"/>
<script type="text/javascript" src="js/jquery-1.10.2.js"></script>
<script type="text/javascript" src="js/style.js"></script>	
<script type="text/javascript" src="js/ConexionWebService.js"></script>
<script type="text/javascript" src="js/ValidacionUsuario.js"></script>
<link rel="stylesheet" media="screen" href="http://code.jquery.com/ui/1.10.4/themes/smoothness/jquery-ui.min.css">
<script src="http://code.jquery.com/jquery-latest.min.js" type="text/javascript"></script>
<script type="text/javascript" src="js/alertify.js"></script>
<link rel="stylesheet" href="css/alertify.core.css" />
<link rel="stylesheet" href="css/alertify.default.css" />
<link rel="stylesheet" href="css/bootstrap.min.css" />
<script src="js/script.js"></script>
<script src="js/jquery.min.js"></script>
<script src="js/photobooth.js"></script>
<style>
          input, select{
        border-radius:8px;
        
        }
  h3 {
        text-shadow: 0px 2px 3px #555;
        }
        </style>
</head>

<body id="bodyBase">
<h5 style="color:#CCC;margin-left:10px; margin-top:5px">Modulo Envio de Mensajes al Monitor</h5>
<h4 align="right" style="color:#FFF;margin-left:10px; margin-top:5px; margin-right: 10px">Bienvenido(a): <label id="usuarioSesion" style="color:#FFF"></label></h4>
<h3 align="right" style="margin-top:2%; margin-right:2%; color:#09C">ENVIO DE MENSAJES AL MONITOR</h3>
	<div id='cssmenu'>
            <ul>
               <li class='' style="display:none" id="AdminCredenciales" class="desactive"><a href='#' title="Admin.Credenciales">ADMINISTRACIÓN DE CREDENCIALES</a>
                  <ul style="margin-right:-42%">
                     <li id="ReemplazoCredencial" style="display:none"><a href='ReemplazarCredencial.html' title="Reemplazo de credenciales">Reemplazo de credenciales</a></li>
                     <li class='last'><a href='AdminCredencial.html' title="Cambio de Estado">CAMBIO DE ESTADO</a></li>
                     <li class='last'><a href='ConsultaMovimientosAcudiente.html' title="Consulta de Movimientos">CONSULTA DE MOVIMIENTOS</a></li>
                     <li class='last'><a href='ConsultaSaldo.html' title="Consulta de Saldos">CONSULTA DE SALDOS</a></li>
                     <li class='last'><a href='ServicioProximoRecargaLinea.php' title="Recarga en Linea">RECARGA EN LINEA</a></li>
                     <li class='last'><a href='TrasladoCredencialAcudiente.html' title="Traslado de Fondos entre Credenciales">TRASLADO DE FONDOS ENTRE CREDENCIALES</a></li>
                  </ul>
               </li>
               
               <li class="" id="RutaEscolar" style="display:none" class="desactive"><a href='#' title="Ruta Escolar">RUTA ESCOLAR</a>
                    <ul style="margin-right:-42%">
                        <li><a href='EnvioMensajesMonitor.html' title="Envío de Mensajes">ENVÍO DE MENSAJES</a></li>
                        <li class='last' title="Tracking"><a href="javascript:void(0);" onclick="enviar_variables();">TRACKING</a></li>
                        <li><a href='#' title="Información de la Ruta">INFORMACIÓN DE LA RUTA</a></li>
                    </ul>
               </li>
               <li class="" id="RestriccionConsumo" style="display:none" class="desactive"><a href='#' title="Restricci&oacute;n de Consumo">RESTRICCI&Oacute;N DE CONSUMO</a>
                    <ul style="margin-right:-42%">
                      <li><a href='RestriccionConsumoValor.html' title="Restricciones por Valor">RESTRICCIONES POR VALOR</a></li>
                      <li><a href='RestriccionConsumoProducto.html' title="Restricciones por Producto">RESTRICCIONES POR PRODUCTO</a></li>
                  </ul>
               </li>
                <li class="" id="RestauranteAcudientes" style="display:none" class="desactive">
                  <a href='#' title="Restaurante">RESTAURANTE</a>
                  <ul style="margin-right:-42%">
                    <li>
                      <a href='MenuSemanal.html' title="Menú Semanal"> 
                        MENÚ SEMANAL
                      </a>
                    </li>
                  </ul>
                </li>              
               
                <li class="" id="Modificacion Datos Perfil" style="display:none" class="desactive"><a href='ModificarAcudiente.html' title="Modificacion Datos Perfil">Modificacion Datos Perfil</a>
                    <ul style="margin-right:-42%">    
                    </ul>
                 </li>
               <li class="" id="Salir"><a href='#' title="Cerrar Sesi&oacute;n">CERRAR SESI&Oacute;N</a>
                    <ul style="margin-right:-42%">
                        
                    </ul>
               </li>
            </ul>

          

        </div>
<div class="contenidoBorde" align="center">
<form id="commentForm" method="post" action="#">
    <table style="padding-left:4%; margin-top:4.5%;margin-right:20px;" cellspacing="0" cellpadding="0" width="80%" align="center">
        <tr>
            <td width="100px"><label for="selectIdCredencial"><font color="#09C" size="2">Estudiante:</font></label></td>
            <td id="estudiantes"></td>                   
        </tr>
        <tr>
            <td height="20px">&nbsp;</td>
        </tr>
        <tr>
            <td><label for="fecha"><font color="#09C" size="2">Fecha:</font></label></td>
            <td><input type="date" id="fecha" name="fecha" style="width:60%"/></td>        
        </tr>
        <tr>
            <td>&nbsp;</td>
        </tr>
        <tr>
            <td><label for="mensaje"><font color="#09C" size="2">Mensaje:</font></label></td>
            <td><textarea id="mensaje" name="mensaje" style="width:80%"></textarea></td>        
        </tr>
        <tr>
            <td>&nbsp;</td>
        </tr>
        <tr>
        	<td colspan="2" align="right"><button class="btn btn-primary" style="margin-right:100px" id="btnEnviar" name="btnEnviar" type="submit">Enviar Mensaje</button></td>
        </tr>
        
    </table>
</form>
</div>
<script src="js/jquery.js"></script>
<script src="js/jquery.validate.js"></script>
<script src="http://code.jquery.com/ui/1.10.4/jquery-ui.min.js"></script>
<script type="text/javascript">
	/*
		Fecha: 			Octubre 22 de 2015
		Descripcion: 	Script para enviar los datos al webservice para que los inserte en la base de datos
	
	*/
	
	//Valor guardado cuando se cierra un popup y se concreto una operación
	var opcionSeleccionar = "";
		
	//Capturar evento del boton crear
	$.validator.setDefaults({
		//Capturar evento del boton crear
		submitHandler: function() {
			if($('input[name="checkEstudiante[]"]:checked').length > 0){
				var iteracion = 0;
				//alert(ObtenerTotalRutasSeleccionadas($('input[name="checkEstudiante[]"]').length));
				if(ObtenerTotalRutasSeleccionadas($('input[name="checkEstudiante[]"]').length) > 0){
				
					$('input[name="checkEstudiante[]"]:checked').each(function(index) {
						var numeroId = $(this).val();
						var coordenadas = $(this).attr("coordenadas");
						var usuario = $(this).attr("usuario");
						var iter = $(this).attr("iter");
						console.log("Iter:" + iter);
						
						$('input[name="checkRuta' + iter + '[]"]:checked').each(function(ind) {
							console.log($(this).val())	
							var idRuta = $(this).val();
							var mensaje = $("#mensaje").val();
							var fecha = $("#fecha").val();
							var date = new Date();
							var horaActual = date.getHours() + ":" + date.getMinutes() + ":" + date.getSeconds(); 
							//Se guardan los datos en un JSON
							var datos = {
								coordenadas: coordenadas,
								idUsuario: usuario,
								fecha: fecha,
								hora: horaActual,
								idRuta: idRuta,
								mensaje: mensaje
							}   
							console.log(index + " : " + ind);
							$.post("ActionInsertarMensajeaMonitor.php", datos)
							.done(function( data ) {
								console.log($.trim(data));
								if($.trim(data) == "1"){
									if((($('input[name="checkEstudiante[]"]:checked').length - 1) == index) && (($('input[name="checkRuta' + iter + '[]"]:checked').length - 1) == ind)){
										alert("¡Se registro con exito el mensaje!");				
										window.location.href = "EnvioMensajesMonitor.html";				
									}
								}
							});	
						})
						
						
					
					});
				}else{
					alert("¡Debe seleccionar al menos una ruta de un estudiante!");				
				}
			}else{
				alert("¡Debe seleccionar al menos un estudiante!");				
			}
			
		}
	});
	
	(function() {
		// use custom tooltip; disable animations for now to work around lack of refresh method on tooltip
		$("#commentForm").tooltip({
			show: false,
			hide: false
		});
	
		// validate signup form on keyup and submit
		$("#commentForm").validate({
			rules: {
				fecha: "required",
				mensaje: "required"
			},
			messages: {
				fecha: "Por favor ingrese una fecha valida",
				mensaje: "Por favor ingrese un mensaje"
			}
		});
	
	})();

	/*
		Fecha: 23 de Octubre de 2015
		Descripcion: Evento para capturar la existencia del usuario en la base de datos al quitar el focus del campo de texto de usuario
	*/
	window.addEventListener('load',init);
	function init(){
		var usuarioSesion = localStorage.getItem("primernombreusuario") + " " + localStorage.getItem("segundonombreusuario") + " " + localStorage.getItem("primerapellidousuario") + " " + localStorage.getItem("segundoapellidousuario"); 
		console.log(usuarioSesion);
		$("#usuarioSesion").html(usuarioSesion);
		var usuarioSesion = localStorage.getItem("usuario");
		localStorage.setItem("ContadorMensajesMonitor",0);
		//Se envian a la funcion que realiza la conexion al werbservice y genera una respuesta que se guarda en un localstorage
		EnviarDatos({acudiente: usuarioSesion}, "ActionListarCredencialesAcudiente.php", "LISTACREDENCIALESACUDIENTESMENSAJE");
		
		
	}
	$("#Salir").click(function(e) {
    var confirmar = window.confirm("¿Desea cerrar sesión?");
    if(confirmar){
  		localStorage.removeItem("usuario");
  		localStorage.removeItem("tipoUsuario");
      localStorage.removeItem("primernombreusuario");
      localStorage.removeItem("segundonombreusuario");
      localStorage.removeItem("primerapellidousuario");
      localStorage.removeItem("segundoapellidousuario");
  		window.location.href = "index.html";
    }
	});

  function enviar_variables(){
    var usuarioSesion = localStorage.getItem("usuario");
    location.href="TrackingPadres.php?proced="+ usuarioSesion;
  } 
	function ObtenerTotalRutasSeleccionadas(lenght){
		var contadorRutas = 0;
		for(i = 0; i < lenght; i++){
			contadorRutas += $('input[name="checkRuta' + i + '[]"]:checked').length;
		}
		return contadorRutas;
	}
</script>
</body>
</html>
